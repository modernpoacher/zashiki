"use strict";var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault");require("core-js/modules/es.regexp.exec");require("core-js/modules/es.string.match");Object.defineProperty(exports,"__esModule",{value:true});exports.default=void 0;var _regenerator=_interopRequireDefault(require("@babel/runtime/regenerator"));require("regenerator-runtime/runtime");var _asyncToGenerator2=_interopRequireDefault(require("@babel/runtime/helpers/asyncToGenerator"));var _boom=_interopRequireDefault(require("@hapi/boom"));var _config=_interopRequireDefault(require("../../../config"));var _zashikiTransport=require("@modernpoacher/zashiki-transport");var _exception=require("../../exception");var JID=_config.default.get('zashiki:jid');var BEARERTOKEN=/[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}/i;var getBearerToken=function getBearerToken(){var value=arguments.length>0&&arguments[0]!==undefined?arguments[0]:'';return(value.match(BEARERTOKEN)||[]).shift();};var _default={assign:'jid',method:function method(_ref,h){return(0,_asyncToGenerator2.default)(_regenerator.default.mark(function _callee(){var _ref$state,state,authorization,_state$jid,jid;return _regenerator.default.wrap(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:_ref$state=_ref.state,state=_ref$state===void 0?{}:_ref$state,authorization=_ref.headers.authorization;_state$jid=state.jid,jid=_state$jid===void 0?getBearerToken(authorization):_state$jid;_context.prev=2;_context.t0=h;_context.t1=jid;if(_context.t1){_context.next=9;break;}_context.next=8;return(0,_zashikiTransport.createJID)();case 8:_context.t1=jid=_context.sent;case 9:_context.t2=_context.t1;_context.t3=JID;_context.t0.state.call(_context.t0,'jid',_context.t2,_context.t3);return _context.abrupt("return",jid);case 15:_context.prev=15;_context.t4=_context["catch"](2);throw _boom.default.badImplementation(_exception.BAD_IMPLEMENTATION,_context.t4);case 18:case"end":return _context.stop();}}},_callee,null,[[2,15]]);}))();}};exports.default=_default;